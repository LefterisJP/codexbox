#!/usr/bin/env bash
set -euo pipefail

# ---------------------------------------------------------------------------
# codexbox: host entrypoint + subcommand dispatcher
#
# Usage:
#   codexbox [--profile name] /path/to/repo [out_dir]    # run Codex container
#   codexbox remote [path/to/repo]      # add/fetch host remote pointing to .codexbox-out/host.git
#   codexbox pull   [path/to/repo]      # fetch + switch -C codexbox-work codexbox/codex
# ---------------------------------------------------------------------------

CODEXBOX_HOME="${CODEXBOX_HOME:-$HOME/.codexbox}"
BIN_DIR="$CODEXBOX_HOME/bin"

die() { echo "ERROR: $*" >&2; exit 1; }

usage() {
  cat >&2 <<'EOF'
Usage:
  codexbox [--profile name] /path/to/repo [out_dir]
  codexbox remote [path/to/repo]
  codexbox pull   [path/to/repo]

Options:
  --profile name    Choose profile (default: rotki). Can also set CODEXBOX_PROFILE env
EOF
}

# --------------------------- subcommand dispatcher --------------------------

cmd="${1:-}"

case "$cmd" in
  remote)
    shift
    [[ -x "$BIN_DIR/cb-remote" ]] || die "Missing or non-executable: $BIN_DIR/cb-remote"
    exec "$BIN_DIR/cb-remote" "${1:-.}"
    ;;
  pull)
    shift
    [[ -x "$BIN_DIR/cb-pull" ]] || die "Missing or non-executable: $BIN_DIR/cb-pull"
    exec "$BIN_DIR/cb-pull" "${1:-.}"
    ;;
  ""|-h|--help|help)
    usage
    exit 0
    ;;
esac

# If we didn't match a subcommand, we treat the first arg as a repo path.
# ------------------------------ args ----------------------------------------

PROFILE_OVERRIDE=""
POSITIONAL=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --profile)
      shift
      [[ $# -gt 0 ]] || die "--profile requires a value"
      PROFILE_OVERRIDE="$1"
      shift
      continue
      ;;
    --profile=*)
      PROFILE_OVERRIDE="${1#*=}"
      shift
      continue
      ;;
    --)
      shift
      POSITIONAL+=("$@")
      break
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    -*)
      die "Unknown option: $1"
      ;;
    *)
      POSITIONAL+=("$1")
      shift
      continue
      ;;
  esac
done

set -- "${POSITIONAL[@]}"

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

REPO="$(realpath "$1")"
OUT="${2:-$REPO/.codexbox-out}"
mkdir -p "$OUT"

# Capture host git identity so the container inherits it
HOST_GIT_NAME=""
if ! HOST_GIT_NAME="$(git -C "$REPO" config user.name 2>/dev/null)"; then
  HOST_GIT_NAME=""
fi
if [[ -z "$HOST_GIT_NAME" ]]; then
  if ! HOST_GIT_NAME="$(git config --global user.name 2>/dev/null)"; then
    HOST_GIT_NAME=""
  fi
fi

HOST_GIT_EMAIL=""
if ! HOST_GIT_EMAIL="$(git -C "$REPO" config user.email 2>/dev/null)"; then
  HOST_GIT_EMAIL=""
fi
if [[ -z "$HOST_GIT_EMAIL" ]]; then
  if ! HOST_GIT_EMAIL="$(git config --global user.email 2>/dev/null)"; then
    HOST_GIT_EMAIL=""
  fi
fi

# ------------------------------ host auth -----------------------------------

HOST_CODEX_HOME="${CODEX_HOME:-$HOME/.codex}"
HOST_AUTH="$HOST_CODEX_HOME/auth.json"
[[ -f "$HOST_AUTH" ]] || die "Can't find auth.json at: $HOST_AUTH (run: codex login)"

# Copy auth.json into outbox so we only mount that file
AUTH_IN_OUT="$OUT/auth.json"
cp -f "$HOST_AUTH" "$AUTH_IN_OUT"
chmod 600 "$AUTH_IN_OUT"

# ------------------------- helpers to mount into container ------------------

# Container-side helper scripts are on the host here:
#   ~/.codexbox/bin/cb-export
#   ~/.codexbox/bin/cb-import
#
# We mount them directly into /usr/local/bin so PATH does not matter.
HOST_CB_EXPORT="$BIN_DIR/cb-export"
HOST_CB_IMPORT="$BIN_DIR/cb-import"

[[ -x "$HOST_CB_EXPORT" ]] || die "Missing or non-executable: $HOST_CB_EXPORT"
[[ -x "$HOST_CB_IMPORT" ]] || die "Missing or non-executable: $HOST_CB_IMPORT"

# ----------------------------- run metadata ---------------------------------

RUN_ID="$(date +%Y%m%d-%H%M%S)"
LOG="$OUT/run-$RUN_ID.log"

# --------------------------- profile config ---------------------------------

PROFILE_DIR="$CODEXBOX_HOME/profiles"

config_profile=""
CONFIG_FILE="$REPO/.codexbox/config"
if [[ -f "$CONFIG_FILE" ]]; then
  config_profile="$(awk -F '=' '
    /^[[:space:]]*#/ {next}
    /^[[:space:]]*profile[[:space:]]*=/ {
      val=$2
      sub(/#.*/, "", val)
      sub(/^[[:space:]]*/, "", val)
      sub(/[[:space:]]*$/, "", val)
      print val
      exit
    }
  ' "$CONFIG_FILE")"
fi

PROFILE_NAME="$PROFILE_OVERRIDE"
[[ -z "$PROFILE_NAME" ]] && PROFILE_NAME="${CODEXBOX_PROFILE:-}"
[[ -z "$PROFILE_NAME" ]] && PROFILE_NAME="$config_profile"
PROFILE_NAME="${PROFILE_NAME:-rotki}"

PROFILE_FILE="$PROFILE_DIR/$PROFILE_NAME.sh"
[[ -f "$PROFILE_FILE" ]] || die "Unknown profile '$PROFILE_NAME' (expected $PROFILE_FILE)"

# shellcheck source=/dev/null
source "$PROFILE_FILE"

PROFILE_IMAGE="${PROFILE_IMAGE:-}"
[[ -n "$PROFILE_IMAGE" ]] || die "Profile '$PROFILE_NAME' did not set PROFILE_IMAGE"

PROFILE_BOOTSTRAP="${PROFILE_BOOTSTRAP:-}"
[[ -n "$PROFILE_BOOTSTRAP" ]] || die "Profile '$PROFILE_NAME' did not set PROFILE_BOOTSTRAP"
[[ -x "$PROFILE_BOOTSTRAP" ]] || die "Bootstrap script not executable: $PROFILE_BOOTSTRAP"

if ! declare -p PROFILE_PODMAN_OPTS >/dev/null 2>&1; then
  PROFILE_PODMAN_OPTS=()
fi

C_PROFILE_BOOTSTRAP="/usr/local/bin/cb-profile-bootstrap"
PROFILE_PODMAN_ARGS_STR=""
for arg in "${PROFILE_PODMAN_OPTS[@]}"; do
  PROFILE_PODMAN_ARGS_STR+=" $(printf '%q' "$arg")"
done

echo "Profile:    $PROFILE_NAME"
echo "Image:      $PROFILE_IMAGE"
echo "Bootstrap:  $PROFILE_BOOTSTRAP"

# --------------------------- container config -------------------------------

# Fixed container paths
C_WORKDIR="/tmp/codexworkspace"
C_CODEX_HOME="/opt/codexbox-home"
C_AUTH_SRC="/tmp/codex-auth/auth.json"

echo "Repo (host):  $REPO"
echo "Out dir:      $OUT"
echo "Log file:     $LOG"
echo

# Minimal container script: prep auth, clone, bootstrap, then run Codex.
# No fancy quoting tricks inside; we use a single-quoted heredoc and pass it safely.
CONTAINER_SCRIPT="$(cat <<'EOS'
set -euo pipefail

WORKDIR="/tmp/codexworkspace"
CODEX_HOME_DIR="/opt/codexbox-home"
AUTH_SRC="/tmp/codex-auth/auth.json"

# Sanity: helper commands must exist
if ! command -v cb-export >/dev/null 2>&1; then
  echo "[codexbox] ERROR: cb-export not found (expected at /usr/local/bin/cb-export)"
  ls -la /usr/local/bin/cb-export /usr/local/bin/cb-import || true
  exit 1
fi

mkdir -p "$CODEX_HOME_DIR"
cp -f "$AUTH_SRC" "$CODEX_HOME_DIR/auth.json"
chmod 600 "$CODEX_HOME_DIR/auth.json"

rm -rf "$WORKDIR"
mkdir -p "$WORKDIR"
git clone --no-hardlinks /src "$WORKDIR"
cd "$WORKDIR"

BOOTSTRAP_SCRIPT="${CODEXBOX_BOOTSTRAP:-/usr/local/bin/cb-profile-bootstrap}"
if [[ -x "$BOOTSTRAP_SCRIPT" ]]; then
  echo "[codexbox] Running profile bootstrap: $BOOTSTRAP_SCRIPT"
  "$BOOTSTRAP_SCRIPT"
else
  echo "[codexbox] Bootstrap script not found or not executable: $BOOTSTRAP_SCRIPT"
fi

# Shared host bridge repo for iterative sync
git init --bare /out/host.git 2>/dev/null || true
git remote add host /out/host.git 2>/dev/null || true

echo "[codexbox] Ready. Use: cb-export \"msg\" to sync to host."
exec codex --dangerously-bypass-approvals-and-sandbox
EOS
)"

# Keep Codex interactive while logging
script -q -f -c "
podman run --rm -it \
  --security-opt=no-new-privileges \
  --cap-drop=all \
  --userns=keep-id \
  --network slirp4netns:allow_host_loopback=false \
  -e CODEX_HOME=$C_CODEX_HOME \
  -e CODEXBOX_BOOTSTRAP=$C_PROFILE_BOOTSTRAP \
  -e CODEXBOX_GIT_NAME=$(printf '%q' "$HOST_GIT_NAME") \
  -e CODEXBOX_GIT_EMAIL=$(printf '%q' "$HOST_GIT_EMAIL") \
  -v \"$REPO\":/src:ro,Z \
  -v \"$OUT\":/out:Z \
  -v \"$AUTH_IN_OUT\":\"$C_AUTH_SRC\":ro,Z \
  -v \"$HOST_CB_EXPORT\":/usr/local/bin/cb-export:ro,Z \
  -v \"$HOST_CB_IMPORT\":/usr/local/bin/cb-import:ro,Z \
  -v \"$PROFILE_BOOTSTRAP\":\"$C_PROFILE_BOOTSTRAP\":ro,Z \
  $PROFILE_PODMAN_ARGS_STR \
  $(printf '%q' "$PROFILE_IMAGE") \
  bash -lc $(printf '%q' "$CONTAINER_SCRIPT")
" "$LOG"

echo
echo "Done."
echo "Log:   $LOG"
echo "Host bridge repo: $OUT/host.git"
