#!/usr/bin/env bash
set -euo pipefail

# ---------------------------------------------------------------------------
# codexbox: host entrypoint + subcommand dispatcher
#
# Usage:
#   codexbox /path/to/repo [out_dir]    # run Codex container
#   codexbox remote [path/to/repo]      # add/fetch host remote pointing to .codexbox-out/host.git
#   codexbox pull   [path/to/repo]      # fetch + switch -C codexbox-work codexbox/codex
# ---------------------------------------------------------------------------

CODEXBOX_HOME="${CODEXBOX_HOME:-$HOME/.codexbox}"
BIN_DIR="$CODEXBOX_HOME/bin"

die() { echo "ERROR: $*" >&2; exit 1; }

usage() {
  cat >&2 <<'EOF'
Usage:
  codexbox /path/to/repo [out_dir]
  codexbox remote [path/to/repo]
  codexbox pull   [path/to/repo]
EOF
}

# --------------------------- subcommand dispatcher --------------------------

cmd="${1:-}"

case "$cmd" in
  remote)
    shift
    [[ -x "$BIN_DIR/cb-remote" ]] || die "Missing or non-executable: $BIN_DIR/cb-remote"
    exec "$BIN_DIR/cb-remote" "${1:-.}"
    ;;
  pull)
    shift
    [[ -x "$BIN_DIR/cb-pull" ]] || die "Missing or non-executable: $BIN_DIR/cb-pull"
    exec "$BIN_DIR/cb-pull" "${1:-.}"
    ;;
  ""|-h|--help|help)
    usage
    exit 0
    ;;
esac

# If we didn't match a subcommand, we treat the first arg as a repo path.
# ------------------------------ args ----------------------------------------

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

REPO="$(realpath "$1")"
OUT="${2:-$REPO/.codexbox-out}"
mkdir -p "$OUT"

# ------------------------------ host auth -----------------------------------

HOST_CODEX_HOME="${CODEX_HOME:-$HOME/.codex}"
HOST_AUTH="$HOST_CODEX_HOME/auth.json"
[[ -f "$HOST_AUTH" ]] || die "Can't find auth.json at: $HOST_AUTH (run: codex login)"

# Copy auth.json into outbox so we only mount that file
AUTH_IN_OUT="$OUT/auth.json"
cp -f "$HOST_AUTH" "$AUTH_IN_OUT"
chmod 600 "$AUTH_IN_OUT"

# ------------------------- helpers to mount into container ------------------

# Container-side helper scripts are on the host here:
#   ~/.codexbox/bin/cb-export
#   ~/.codexbox/bin/cb-import
#
# We mount them directly into /usr/local/bin so PATH does not matter.
HOST_CB_EXPORT="$BIN_DIR/cb-export"
HOST_CB_IMPORT="$BIN_DIR/cb-import"

[[ -x "$HOST_CB_EXPORT" ]] || die "Missing or non-executable: $HOST_CB_EXPORT"
[[ -x "$HOST_CB_IMPORT" ]] || die "Missing or non-executable: $HOST_CB_IMPORT"

# ----------------------------- run metadata ---------------------------------

RUN_ID="$(date +%Y%m%d-%H%M%S)"
LOG="$OUT/run-$RUN_ID.log"

# --------------------------- container config -------------------------------

IMAGE="codexbox:latest"

# Fixed container paths
C_WORKDIR="/tmp/codexworkspace"
C_CODEX_HOME="/tmp/.codex"
C_AUTH_SRC="/tmp/codex-auth/auth.json"

echo "Repo (host):  $REPO"
echo "Out dir:      $OUT"
echo "Log file:     $LOG"
echo

# Minimal container script: prep auth, clone, bootstrap, then run Codex.
# No fancy quoting tricks inside; we use a single-quoted heredoc and pass it safely.
CONTAINER_SCRIPT="$(cat <<'EOS'
set -euo pipefail

WORKDIR="/tmp/codexworkspace"
CODEX_HOME_DIR="/tmp/.codex"
AUTH_SRC="/tmp/codex-auth/auth.json"

# Sanity: helper commands must exist
if ! command -v cb-export >/dev/null 2>&1; then
  echo "[codexbox] ERROR: cb-export not found (expected at /usr/local/bin/cb-export)"
  ls -la /usr/local/bin/cb-export /usr/local/bin/cb-import || true
  exit 1
fi

mkdir -p "$CODEX_HOME_DIR"
cp -f "$AUTH_SRC" "$CODEX_HOME_DIR/auth.json"
chmod 600 "$CODEX_HOME_DIR/auth.json"

rm -rf "$WORKDIR"
mkdir -p "$WORKDIR"
git clone --no-hardlinks /src "$WORKDIR"
cd "$WORKDIR"

# rotki-style uv bootstrap when possible, fallback for generic projects
if [[ -f pyproject.toml ]] && command -v uv >/dev/null 2>&1; then
  echo "[codexbox] Bootstrapping python env via uv..."
  if uv sync --group dev --group lint; then
    :
  else
    echo "[codexbox] uv groups not available; falling back to 'uv sync'"
    uv sync || true
  fi
fi

# Shared host bridge repo for iterative sync
git init --bare /out/host.git 2>/dev/null || true
git remote add host /out/host.git 2>/dev/null || true

echo "[codexbox] Ready. Use: cb-export \"msg\" to sync to host."
exec codex --dangerously-bypass-approvals-and-sandbox
EOS
)"

# Keep Codex interactive while logging
script -q -f -c "
podman run --rm -it \
  --security-opt=no-new-privileges \
  --cap-drop=all \
  --userns=keep-id \
  --network slirp4netns:allow_host_loopback=false \
  -e CODEX_HOME=$C_CODEX_HOME \
  -v \"$REPO\":/src:ro,Z \
  -v \"$OUT\":/out:Z \
  -v \"$AUTH_IN_OUT\":\"$C_AUTH_SRC\":ro,Z \
  -v \"$HOST_CB_EXPORT\":/usr/local/bin/cb-export:ro,Z \
  -v \"$HOST_CB_IMPORT\":/usr/local/bin/cb-import:ro,Z \
  $IMAGE \
  bash -lc $(printf '%q' "$CONTAINER_SCRIPT")
" "$LOG"

echo
echo "Done."
echo "Log:   $LOG"
echo "Host bridge repo: $OUT/host.git"
