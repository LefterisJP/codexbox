#!/usr/bin/env bash
set -euo pipefail

usage() { echo "Usage: codexbox /path/to/repo [out_dir]"; }

if [[ $# -lt 1 ]]; then usage; exit 1; fi

REPO="$(realpath "$1")"
OUT="${2:-$REPO/.codexbox-out}"
mkdir -p "$OUT"

# Host-side Codex OAuth token
HOST_CODEX_HOME="${CODEX_HOME:-$HOME/.codex}"
HOST_AUTH="$HOST_CODEX_HOME/auth.json"
if [[ ! -f "$HOST_AUTH" ]]; then
  echo "ERROR: Can't find auth.json at: $HOST_AUTH"
  echo "Run once on host: codex login"
  exit 1
fi

# Helpers on host (single source of truth)
HOST_HELPERS_DIR="$HOME/.codexbox/bin"
if [[ ! -d "$HOST_HELPERS_DIR" ]]; then
  echo "ERROR: Missing helpers dir: $HOST_HELPERS_DIR"
  echo "Expected files: cb-export, cb-import"
  exit 1
fi
if [[ ! -x "$HOST_HELPERS_DIR/cb-export" ]]; then
  echo "ERROR: $HOST_HELPERS_DIR/cb-export is missing or not executable"
  exit 1
fi

# Copy auth.json into outbox so we only mount that file
AUTH_IN_OUT="$OUT/auth.json"
cp -f "$HOST_AUTH" "$AUTH_IN_OUT"
chmod 600 "$AUTH_IN_OUT"

RUN_ID="$(date +%Y%m%d-%H%M%S)"
LOG="$OUT/run-$RUN_ID.log"

IMAGE="codexbox:latest"

# Fixed container paths
C_WORKDIR="/tmp/codexworkspace"
C_CODEX_HOME="/tmp/.codex"
C_AUTH_SRC="/tmp/codex-auth/auth.json"
C_HELPERS_DIR="/codexbox-bin"

# Make PATH deterministic (don’t rely on whatever shells load)
C_PATH="$C_HELPERS_DIR:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

echo "Repo (host):  $REPO"
echo "Out dir:      $OUT"
echo "Log file:     $LOG"
echo

CONTAINER_SCRIPT="$(cat <<'EOS'
set -euo pipefail

WORKDIR="/tmp/codexworkspace"
CODEX_HOME_DIR="/tmp/.codex"
AUTH_SRC="/tmp/codex-auth/auth.json"

# Force PATH inside the container script too (this is the key fix)
export PATH="/codexbox-bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# Hard fail early if helpers aren’t visible
if ! command -v cb-export >/dev/null 2>&1; then
  echo "[codexbox] ERROR: cb-export not found on PATH"
  echo "[codexbox] PATH=$PATH"
  echo "[codexbox] Listing /codexbox-bin:"
  ls -la /codexbox-bin || true
  exit 1
fi

mkdir -p "$CODEX_HOME_DIR"
cp -f "$AUTH_SRC" "$CODEX_HOME_DIR/auth.json"
chmod 600 "$CODEX_HOME_DIR/auth.json"

rm -rf "$WORKDIR"
mkdir -p "$WORKDIR"
git clone --no-hardlinks /src "$WORKDIR"
cd "$WORKDIR"

# rotki-style uv bootstrap when possible, fallback for generic projects
if [[ -f pyproject.toml ]] && command -v uv >/dev/null 2>&1; then
  echo "[codexbox] Bootstrapping python env via uv..."
  if uv sync --group dev --group lint; then
    :
  else
    echo "[codexbox] uv groups not available; falling back to 'uv sync'"
    uv sync || true
  fi
fi

# Shared host bridge repo for iterative sync
git init --bare /out/host.git 2>/dev/null || true
git remote add host /out/host.git 2>/dev/null || true

echo "[codexbox] Helpers ready: cb-export, cb-import"
echo "[codexbox] Tip: use 'cb-export \"msg\"' any time to sync work to host."

exec codex --dangerously-bypass-approvals-and-sandbox
EOS
)"

# Keep Codex interactive while logging
script -q -f -c "
podman run --rm -it \
  --security-opt=no-new-privileges \
  --cap-drop=all \
  --userns=keep-id \
  --network slirp4netns:allow_host_loopback=false \
  -e CODEX_HOME=$C_CODEX_HOME \
  -e PATH=$C_PATH \
  -v \"$REPO\":/src:ro,Z \
  -v \"$OUT\":/out:Z \
  -v \"$AUTH_IN_OUT\":\"$C_AUTH_SRC\":ro,Z \
  -v "$HOME/.codexbox/bin/cb-export:/usr/local/bin/cb-export:ro,Z" \
  -v "$HOME/.codexbox/bin/cb-import:/usr/local/bin/cb-import:ro,Z" \
  $IMAGE \
  bash -lc $(printf '%q' "$CONTAINER_SCRIPT")
" "$LOG"

echo
echo "Done."
echo "Log:   $LOG"
echo "Host bridge repo: $OUT/host.git"
